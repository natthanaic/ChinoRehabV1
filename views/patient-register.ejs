<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Patient - HL7 FHIR - ChinoRehab System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.08);
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.85);
            padding: 0.75rem 1rem;
            margin: 0.25rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        .form-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border: 1px solid #e0e0e0;
        }

        .form-section h5 {
            color: #667eea;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
            font-weight: 600;
        }

        .required::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        .badge-auto {
            background-color: #6c757d;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .alert-info {
            background-color: #e7f3ff;
            border-color: #b3d9ff;
            color: #004085;
        }

        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Mobile navbar toggle -->
    <nav class="navbar navbar-dark bg-dark d-md-none">
        <div class="container-fluid">
            <span class="navbar-brand">ChinoRehab System</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/sidebar', { user, activePage: 'patient-register' }) %>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-person-plus-fill me-2"></i>
                        Register New Patient (HL7 FHIR)
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="history.back()">
                            <i class="bi bi-arrow-left me-1"></i>Back
                        </button>
                    </div>
                </div>

                <!-- Info Alert -->
                <div class="alert alert-info mb-4" role="alert">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    This form follows <strong>HL7 FHIR R4</strong> standards for interoperable healthcare data.
                    Fields marked with <span class="text-danger">*</span> are required.
                </div>

                <form id="patientForm" novalidate>

                    <!-- ==================== IDENTIFIERS ==================== -->
                    <div class="form-section">
                        <h5><i class="bi bi-fingerprint me-2"></i>Patient Identifiers</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="hn" class="form-label required">HN (Hospital Number)</label>
                                <input type="text" class="form-control" id="hn" required placeholder="PT25XXX">
                                <div class="form-text">Medical Record Number (MRN)</div>
                                <div class="invalid-feedback">Please provide Hospital Number</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="pt_number" class="form-label">
                                    PT Number <span class="badge badge-auto">Auto</span>
                                </label>
                                <input type="text" class="form-control" id="pt_number" readonly placeholder="Auto-generated">
                                <div class="form-text">Physical Therapy Number</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="pid" class="form-label">National ID (Thai ID)</label>
                                <input type="text" class="form-control" id="pid" maxlength="13" placeholder="1234567890123">
                                <div class="form-text">13 digits for Thai citizens</div>
                                <div class="invalid-feedback">Invalid Thai National ID format</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="passport_no" class="form-label">Passport Number</label>
                                <input type="text" class="form-control" id="passport_no" placeholder="A12345678">
                                <div class="form-text">For non-Thai citizens</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="ssn" class="form-label">SSN / Other ID</label>
                                <input type="text" class="form-control" id="ssn" placeholder="XXX-XX-XXXX">
                                <div class="form-text">Social Security or other ID</div>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== NAME INFORMATION ==================== -->
                    <div class="form-section">
                        <h5><i class="bi bi-person-vcard me-2"></i>Name Information</h5>
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label for="title" class="form-label">Title/Prefix</label>
                                <select class="form-select" id="title">
                                    <option value="">Select</option>
                                    <option value="Mr.">Mr.</option>
                                    <option value="Mrs.">Mrs.</option>
                                    <option value="Ms.">Ms.</option>
                                    <option value="Miss">Miss</option>
                                    <option value="Dr.">Dr.</option>
                                    <option value="Prof.">Prof.</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="first_name" class="form-label required">Given Name (First Name)</label>
                                <input type="text" class="form-control" id="first_name" required placeholder="First name">
                                <div class="invalid-feedback">Please provide given name</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="middle_name" class="form-label">Middle Name</label>
                                <input type="text" class="form-control" id="middle_name" placeholder="Middle name">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="last_name" class="form-label required">Family Name (Last Name)</label>
                                <input type="text" class="form-control" id="last_name" required placeholder="Last name">
                                <div class="invalid-feedback">Please provide family name</div>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== DEMOGRAPHICS ==================== -->
                    <div class="form-section">
                        <h5><i class="bi bi-calendar3 me-2"></i>Demographics</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="dob" class="form-label required">Date of Birth</label>
                                <input type="text" class="form-control" id="dob" required placeholder="YYYY-MM-DD">
                                <div class="form-text">ISO 8601 format</div>
                                <div class="invalid-feedback">Please provide birth date</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="gender" class="form-label required">Gender</label>
                                <select class="form-select" id="gender" required>
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                                <div class="form-text">Administrative gender</div>
                                <div class="invalid-feedback">Please select gender</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="marital_status" class="form-label">Marital Status</label>
                                <select class="form-select" id="marital_status">
                                    <option value="">Select</option>
                                    <option value="S">Single (Never Married)</option>
                                    <option value="M">Married</option>
                                    <option value="D">Divorced</option>
                                    <option value="W">Widowed</option>
                                    <option value="T">Domestic Partner</option>
                                    <option value="L">Legally Separated</option>
                                </select>
                                <div class="form-text">HL7 v3 code</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="language_primary" class="form-label">Primary Language</label>
                                <select class="form-select" id="language_primary">
                                    <option value="">Select</option>
                                    <option value="th">Thai (ไทย)</option>
                                    <option value="en">English</option>
                                    <option value="zh">Chinese (中文)</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="ja">Japanese</option>
                                    <option value="es">Spanish</option>
                                </select>
                                <div class="form-text">ISO 639-1 code</div>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== CONTACT INFORMATION ==================== -->
                    <div class="form-section">
                        <h5><i class="bi bi-telephone-fill me-2"></i>Contact Information</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="phone" class="form-label">Phone (Home/Work)</label>
                                <input type="tel" class="form-control" id="phone" placeholder="+66-XX-XXX-XXXX">
                                <div class="form-text">E.164 format recommended</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="mobile" class="form-label">Mobile Phone</label>
                                <input type="tel" class="form-control" id="mobile" placeholder="+66-XX-XXX-XXXX">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" placeholder="patient@example.com">
                                <div class="form-text">RFC 5322 format</div>
                                <div class="invalid-feedback">Invalid email format</div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="fax" class="form-label">Fax</label>
                                <input type="tel" class="form-control" id="fax" placeholder="Fax number">
                            </div>
                        </div>
                    </div>

                    <!-- ==================== ADDRESS ==================== -->
                    <div class="form-section">
                        <h5><i class="bi bi-geo-alt-fill me-2"></i>Address Information</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="address_line1" class="form-label">Street Address Line 1</label>
                                <input type="text" class="form-control" id="address_line1" placeholder="123 Main Street">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="address_line2" class="form-label">Street Address Line 2</label>
                                <input type="text" class="form-control" id="address_line2" placeholder="Apartment, Unit, Suite">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="address_city" class="form-label">City</label>
                                <input type="text" class="form-control" id="address_city" placeholder="Bangkok">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="address_district" class="form-label">District/County</label>
                                <input type="text" class="form-control" id="address_district" placeholder="Amphoe/District">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="address_state" class="form-label">State/Province</label>
                                <input type="text" class="form-control" id="address_state" placeholder="Province">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="address_postal_code" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="address_postal_code" placeholder="10100">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="address_country" class="form-label">Country</label>
                                <select class="form-select" id="address_country">
                                    <option value="">Select Country</option>
                                    <option value="TH" selected>Thailand</option>
                                    <option value="US">United States</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="CN">China</option>
                                    <option value="JP">Japan</option>
                                    <option value="DE">Germany</option>
                                    <option value="FR">France</option>
                                </select>
                                <div class="form-text">ISO 3166-1 code</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="address" class="form-label">Full Address (Display)</label>
                                <textarea class="form-control" id="address" rows="2" placeholder="Auto-filled or enter manually"></textarea>
                                <div class="form-text">Combined address text</div>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== EMERGENCY CONTACT ==================== -->
                    <div class="form-section">
                        <h5><i class="bi bi-person-exclamation me-2"></i>Emergency Contact</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="emergency_contact" class="form-label">Contact Name</label>
                                <input type="text" class="form-control" id="emergency_contact" placeholder="Full name">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="emergency_relationship" class="form-label">Relationship</label>
                                <select class="form-select" id="emergency_relationship">
                                    <option value="">Select</option>
                                    <option value="spouse">Spouse</option>
                                    <option value="parent">Parent</option>
                                    <option value="child">Child</option>
                                    <option value="sibling">Sibling</option>
                                    <option value="friend">Friend</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="emergency_phone" class="form-label">Contact Phone</label>
                                <input type="tel" class="form-control" id="emergency_phone" placeholder="+66-XX-XXX-XXXX">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="emergency_email" class="form-label">Contact Email</label>
                                <input type="email" class="form-control" id="emergency_email" placeholder="contact@example.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="emergency_address" class="form-label">Contact Address</label>
                                <textarea class="form-control" id="emergency_address" rows="2" placeholder="Full address"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== CLINICAL INFORMATION ==================== -->
                    <div class="form-section">
                        <h5><i class="bi bi-heart-pulse me-2"></i>Clinical Information</h5>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="diagnosis" class="form-label required">Primary Diagnosis</label>
                                <textarea class="form-control" id="diagnosis" rows="3" required placeholder="Chief complaint or primary diagnosis"></textarea>
                                <div class="invalid-feedback">Please provide primary diagnosis</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="medical_history" class="form-label">Medical History</label>
                                <textarea class="form-control" id="medical_history" rows="3" placeholder="Past medical conditions, surgeries"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="allergies" class="form-label">Allergies</label>
                                <textarea class="form-control" id="allergies" rows="3" placeholder="Known allergies (medications, food, environmental)"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="medications" class="form-label">Current Medications</label>
                                <textarea class="form-control" id="medications" rows="2" placeholder="List of current medications with dosages"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== REHABILITATION PLAN ==================== -->
                    <div class="form-section">
                        <h5><i class="bi bi-clipboard2-pulse me-2"></i>Rehabilitation Plan</h5>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Rehabilitation Goals</label>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Pain reduction" id="goal1">
                                            <label class="form-check-label" for="goal1">Pain reduction</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Improve ROM" id="goal2">
                                            <label class="form-check-label" for="goal2">Improve range of motion</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Strengthen muscles" id="goal3">
                                            <label class="form-check-label" for="goal3">Strengthen muscles</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="Improve function" id="goal4">
                                            <label class="form-check-label" for="goal4">Improve function</label>
                                        </div>
                                    </div>
                                </div>
                                <input type="text" class="form-control mt-2" id="rehab_goal_other" placeholder="Other goals (comma-separated)">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="body_area" class="form-label">Body Area Affected</label>
                                <select class="form-select" id="body_area">
                                    <option value="">Select</option>
                                    <option value="Neck">Neck</option>
                                    <option value="Shoulder">Shoulder</option>
                                    <option value="Elbow">Elbow</option>
                                    <option value="Wrist/Hand">Wrist/Hand</option>
                                    <option value="Upper Back">Upper Back</option>
                                    <option value="Lower Back">Lower Back</option>
                                    <option value="Hip">Hip</option>
                                    <option value="Knee">Knee</option>
                                    <option value="Ankle/Foot">Ankle/Foot</option>
                                    <option value="Multiple Areas">Multiple Areas</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="frequency" class="form-label">Treatment Frequency</label>
                                <select class="form-select" id="frequency">
                                    <option value="">Select</option>
                                    <option value="Daily">Daily</option>
                                    <option value="3 times/week">3 times/week</option>
                                    <option value="2 times/week">2 times/week</option>
                                    <option value="Weekly">Weekly</option>
                                    <option value="As needed">As needed</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="expected_duration" class="form-label">Expected Duration</label>
                                <select class="form-select" id="expected_duration">
                                    <option value="">Select</option>
                                    <option value="1-2 weeks">1-2 weeks</option>
                                    <option value="2-4 weeks">2-4 weeks</option>
                                    <option value="1-2 months">1-2 months</option>
                                    <option value="2-3 months">2-3 months</option>
                                    <option value="3-6 months">3-6 months</option>
                                    <option value="Long-term">Long-term (6+ months)</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="precaution" class="form-label">Precautions</label>
                                <textarea class="form-control" id="precaution" rows="2" placeholder="Clinical precautions for treatment"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="contraindication" class="form-label">Contraindications</label>
                                <textarea class="form-control" id="contraindication" rows="2" placeholder="Treatment contraindications"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="doctor_note" class="form-label">Doctor's Notes</label>
                                <textarea class="form-control" id="doctor_note" rows="2" placeholder="Referring physician notes"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== CLINIC ASSIGNMENT ==================== -->
                    <% if (user.role === 'ADMIN' || user.role === 'PT' || user.role === 'PT_ADMIN') { %>
                    <div class="form-section">
                        <h5><i class="bi bi-building me-2"></i>Managing Organization</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="clinic_id" class="form-label required">Clinic</label>
                                <select class="form-select" id="clinic_id" required>
                                    <option value="">Select Clinic</option>
                                </select>
                                <div class="form-text">FHIR Organization reference</div>
                                <div class="invalid-feedback">Please select a clinic</div>
                            </div>
                        </div>
                    </div>
                    <% } %>

                    <!-- ==================== ACTION BUTTONS ==================== -->
                    <div class="text-center mt-4 mb-5">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="bi bi-save me-2"></i>Register Patient
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg ms-3 px-5" onclick="clearForm()">
                            <i class="bi bi-x-circle me-2"></i>Clear Form
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="/js/utils.js"></script>
    <script>
        // ============================================================================
        // HL7 FHIR Patient Registration - Enhanced JavaScript
        // ============================================================================

        // Initialize date picker (ISO 8601 format)
        flatpickr('#dob', {
            dateFormat: 'Y-m-d',
            maxDate: 'today',
            altInput: true,
            altFormat: 'F j, Y'
        });

        // Load clinics
        async function loadClinics() {
            try {
                const token = getCookie('authToken');
                const response = await fetch('/api/clinics', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const clinics = await response.json();
                    const select = document.getElementById('clinic_id');
                    if (select) {
                        clinics.forEach(clinic => {
                            const option = document.createElement('option');
                            option.value = clinic.id;
                            option.textContent = clinic.name;
                            select.appendChild(option);
                        });

                        // Pre-select user's clinic if CLINIC role
                        const user = JSON.parse(localStorage.getItem('user') || '{}');
                        if (user.role === 'CLINIC' && user.clinic_id) {
                            select.value = user.clinic_id;
                            select.disabled = true;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading clinics:', error);
            }
        }

        // Validate Thai National ID (13 digits with checksum)
        function validateThaiNationalID(id) {
            if (!/^\d{13}$/.test(id)) return false;

            let sum = 0;
            for (let i = 0; i < 12; i++) {
                sum += parseInt(id[i]) * (13 - i);
            }
            const checksum = (11 - (sum % 11)) % 10;
            return checksum === parseInt(id[12]);
        }

        // Validate email (RFC 5322 simplified)
        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // Auto-fill address text from structured fields
        function updateAddressText() {
            const line1 = document.getElementById('address_line1')?.value || '';
            const line2 = document.getElementById('address_line2')?.value || '';
            const city = document.getElementById('address_city')?.value || '';
            const district = document.getElementById('address_district')?.value || '';
            const state = document.getElementById('address_state')?.value || '';
            const postal = document.getElementById('address_postal_code')?.value || '';
            const country = document.getElementById('address_country')?.selectedOptions[0]?.text || '';

            const parts = [line1, line2, city, district, state, postal, country].filter(p => p.trim() !== '');
            const fullAddress = parts.join(', ');

            if (fullAddress) {
                document.getElementById('address').value = fullAddress;
            }
        }

        // Setup auto-fill listeners
        const addressFields = ['address_line1', 'address_line2', 'address_city', 'address_district', 'address_state', 'address_postal_code', 'address_country'];
        addressFields.forEach(fieldId => {
            document.getElementById(fieldId)?.addEventListener('input', updateAddressText);
        });

        // Validate National ID on blur
        document.getElementById('pid')?.addEventListener('blur', (e) => {
            const value = e.target.value;
            if (value && value.length === 13) {
                if (!validateThaiNationalID(value)) {
                    e.target.classList.add('is-invalid');
                } else {
                    e.target.classList.remove('is-invalid');
                    e.target.classList.add('is-valid');
                }
            }
        });

        // Validate email on blur
        document.getElementById('email')?.addEventListener('blur', (e) => {
            const value = e.target.value;
            if (value && !validateEmail(value)) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
                if (value) e.target.classList.add('is-valid');
            }
        });

        // Form submission with HL7 FHIR data
        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate form
            const form = e.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                showAlert('Please fill in all required fields correctly', 'danger');
                return;
            }

            // Collect rehabilitation goals
            const goals = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                goals.push(cb.value);
            });
            const otherGoals = document.getElementById('rehab_goal_other').value;
            if (otherGoals) {
                goals.push(...otherGoals.split(',').map(g => g.trim()));
            }

            // Build HL7 FHIR-compliant payload (backward compatible with existing API)
            const formData = {
                // Identifiers
                hn: document.getElementById('hn').value,
                pt_number: document.getElementById('pt_number').value || undefined,
                pid: document.getElementById('pid').value,
                passport_no: document.getElementById('passport_no').value,
                ssn: document.getElementById('ssn').value,

                // Name
                title: document.getElementById('title').value,
                first_name: document.getElementById('first_name').value,
                middle_name: document.getElementById('middle_name').value,
                last_name: document.getElementById('last_name').value,

                // Demographics
                gender: document.getElementById('gender').value,
                dob: document.getElementById('dob').value,
                marital_status: document.getElementById('marital_status').value,
                language_primary: document.getElementById('language_primary').value,

                // Contact
                phone: document.getElementById('phone').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value,
                fax: document.getElementById('fax').value,

                // Address (structured)
                address_line1: document.getElementById('address_line1').value,
                address_line2: document.getElementById('address_line2').value,
                address_city: document.getElementById('address_city').value,
                address_district: document.getElementById('address_district').value,
                address_state: document.getElementById('address_state').value,
                address_postal_code: document.getElementById('address_postal_code').value,
                address_country: document.getElementById('address_country').value,
                address: document.getElementById('address').value,

                // Emergency Contact
                emergency_contact: document.getElementById('emergency_contact').value,
                emergency_relationship: document.getElementById('emergency_relationship').value,
                emergency_phone: document.getElementById('emergency_phone').value,
                emergency_email: document.getElementById('emergency_email').value,
                emergency_address: document.getElementById('emergency_address').value,

                // Clinical
                diagnosis: document.getElementById('diagnosis').value,
                medical_history: document.getElementById('medical_history').value,
                allergies: document.getElementById('allergies').value,
                medications: document.getElementById('medications').value,

                // Rehabilitation
                rehab_goal: goals.join(', '),
                rehab_goal_other: document.getElementById('rehab_goal_other').value,
                body_area: document.getElementById('body_area').value,
                frequency: document.getElementById('frequency').value,
                expected_duration: document.getElementById('expected_duration').value,
                precaution: document.getElementById('precaution').value,
                contraindication: document.getElementById('contraindication').value,
                doctor_note: document.getElementById('doctor_note').value
            };

            // Add clinic_id if available
            const clinicSelect = document.getElementById('clinic_id');
            if (clinicSelect) {
                formData.clinic_id = clinicSelect.value;
            }

            try {
                const token = getCookie('authToken');
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Registering...';

                const response = await fetch('/api/patients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(`Patient registered successfully!<br>PT Number: ${result.pt_number}`, 'success');

                    // Ask if want to create PN case
                    setTimeout(() => {
                        if (confirm('Do you want to create a PN case for this patient?')) {
                            window.location.href = `/patient/${result.patient_id}#create-pn`;
                        } else {
                            window.location.href = '/patients';
                        }
                    }, 1000);
                } else {
                    const error = await response.json();
                    showAlert('Error: ' + (error.error || 'Registration failed'), 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Network error:', error);
                showAlert('Network error. Please try again.', 'danger');
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-save me-2"></i>Register Patient';
            }
        });

        function clearForm() {
            if (confirm('Are you sure you want to clear all form data? This cannot be undone.')) {
                document.getElementById('patientForm').reset();
                document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
                    el.classList.remove('is-valid', 'is-invalid');
                });
                showAlert('Form cleared', 'info');
            }
        }

        function showAlert(message, type = 'info') {
            const existingAlerts = document.querySelectorAll('.alert-dismissible');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const main = document.querySelector('main');
            main.insertBefore(alertDiv, main.firstChild.nextSibling);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadClinics();
            console.log('HL7 FHIR Patient Registration - Ready');
        });
    </script>
</body>
</html>
