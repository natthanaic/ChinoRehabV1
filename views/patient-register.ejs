<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Patient - HL7 FHIR - ChinoRehab System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <style>
        /* --- REVERTED --- Removed body background-color */
        body {
            /* background-color: #f9fbfd; */
        }

        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.08);
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.85);
            padding: 0.75rem 1rem;
            margin: 0.25rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        /* --- REVERTED --- Restored original .form-section styles */
        .form-section {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #e0e0e0;
        }

        /* --- REVERTED --- Removed .form-section:hover */

        /* --- REVERTED --- Restored original .form-section h5 styles */
        .form-section h5 {
            color: #667eea;
            margin-bottom: 0.75rem;
            padding-bottom: 0.4rem;
            border-bottom: 2px solid #667eea;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* --- REVERTED --- Removed .form-section h5 i styles */

        .required::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        .badge-auto {
            background-color: #6c757d;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .alert-info {
            background-color: #e7f3ff;
            border-color: #b3d9ff;
            color: #004085;
        }

        .form-text {
            font-size: 0.875rem;
            color: #6c757d;
        }

        /* --- REVERTED --- Removed main .h2 styles */

        /* --- REVERTED --- Removed .btn-primary styles */
    </style>
</head>
<body>
    <!-- Mobile navbar toggle -->
    <nav class="navbar navbar-dark bg-dark d-md-none">
        <div class="container-fluid">
            <span class="navbar-brand">ChinoRehab System</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/sidebar', { user, activePage: 'patient-register' }) %>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-person-plus-fill me-2"></i>
                        Register New Patient
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="history.back()">
                            <i class="bi bi-arrow-left me-1"></i>Back
                        </button>
                    </div>
                </div>

                <form id="patientForm" novalidate>

                    <!-- ROW 1: Identifiers + Name -->
                    <div class="row">
                        <div class="col-lg-6 mb-2">
                            <!-- ==================== IDENTIFIERS ==================== -->
                            <div class="form-section h-100">
                                <h5><i class="bi bi-fingerprint me-2"></i>Patient Identifiers</h5>

                                <!-- Thai ID & Passport Input -->
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="pidInput" class="form-label">Thai ID</label>
                                        <input type="text" class="form-control form-control-sm" id="pidInput" name="pidInput" maxlength="13" placeholder="1234567890123">
                                        <div class="form-text" style="font-size: 0.7rem;">Optional if Passport provided</div>
                                        <div class="invalid-feedback" id="pidErrorText"></div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="passportInput" class="form-label">Passport</label>
                                        <input type="text" class="form-control form-control-sm" id="passportInput" name="passportInput" maxlength="20" placeholder="AB1234567">
                                        <div class="form-text" style="font-size: 0.7rem;">Optional if Thai ID provided</div>
                                        <div class="invalid-feedback" id="passportErrorText"></div>
                                    </div>
                                </div>

                                <!-- Check ID Button -->
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <div class="alert alert-info py-1 px-2 mb-1" style="font-size: 0.75rem;">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <strong>Optional:</strong> Provide Thai ID or Passport to check duplicates. Click below to generate HN.
                                        </div>
                                        <button class="btn btn-primary btn-sm w-100" type="button" id="btnCheckID">
                                            <i class="bi bi-search"></i> Check ID & Generate HN
                                        </button>
                                    </div>
                                </div>

                                <!-- Verification Alert -->
                                <div class="row">
                                    <div class="col-12" id="verificationSection" style="display: none;">
                                        <div class="alert py-2 px-2 mb-2" role="alert" id="verificationAlert" style="font-size: 0.8rem;"></div>
                                    </div>
                                </div>

                                <!-- HN & PT# (Auto-generated) -->
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="hn" class="form-label required">HN <span class="badge badge-auto">Auto</span></label>
                                        <input type="text" class="form-control form-control-sm" id="hn" name="hn" required readonly placeholder="PT25XXX">
                                        <div class="form-text" style="font-size: 0.7rem;">Generated after verification</div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="pt_number" class="form-label">PT# <span class="badge badge-auto">Auto</span></label>
                                        <input type="text" class="form-control form-control-sm" id="pt_number" name="pt_number" readonly placeholder="Auto">
                                        <div class="form-text" style="font-size: 0.7rem;">Generated on save</div>
                                    </div>
                                </div>

                                <!-- Hidden fields for backward compatibility -->
                                <input type="hidden" id="pid" name="pid">
                                <input type="hidden" id="passport" name="passport">

                                <!-- Other ID -->
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="ssn" class="form-label">Other ID</label>
                                        <input type="text" class="form-control form-control-sm" id="ssn" name="ssn" placeholder="SSN or other">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 mb-2">
                            <!-- ==================== NAME INFORMATION ==================== -->
                            <div class="form-section h-100">
                                <h5><i class="bi bi-person-vcard me-2"></i>Name Information</h5>
                                <div class="row">
                                    <div class="col-md-2 mb-2">
                                        <label for="title" class="form-label">Title</label>
                                        <input type="text" class="form-control form-control-sm" id="title" placeholder="Mr." list="titleList">
                                        <datalist id="titleList">
                                            <option value="Mr.">
                                            <option value="Mrs.">
                                            <option value="Ms.">
                                            <option value="Miss">
                                            <option value="Dr.">
                                            <option value="Prof.">
                                        </datalist>
                                    </div>
                                    <div class="col-md-5 mb-2">
                                        <label for="first_name" class="form-label required">First Name</label>
                                        <input type="text" class="form-control form-control-sm" id="first_name" required placeholder="First">
                                        <div class="invalid-feedback">Required</div>
                                    </div>
                                    <div class="col-md-5 mb-2">
                                        <label for="last_name" class="form-label required">Last Name</label>
                                        <input type="text" class="form-control form-control-sm" id="last_name" required placeholder="Last">
                                        <div class="invalid-feedback">Required</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-2">
                                        <label for="middle_name" class="form-label">Middle Name</label>
                                        <input type="text" class="form-control form-control-sm" id="middle_name" placeholder="Middle name (optional)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 2: Demographics & Contact (Full Width) -->
                    <div class="row">
                        <div class="col-12 mb-2">
                            <div class="form-section">
                                <h5><i class="bi bi-calendar3 me-2"></i>Demographics & Contact</h5>
                                <div class="row">
                                    <div class="col-lg-2 col-md-3 mb-2">
                                        <label for="dob" class="form-label required">Date of Birth</label>
                                        <input type="text" class="form-control form-control-sm" id="dob" required placeholder="DD/MM/YYYY">
                                        <div class="invalid-feedback">Enter DD/MM/YYYY</div>
                                    </div>
                                    <div class="col-lg-2 col-md-3 mb-2">
                                        <label for="gender" class="form-label required">Gender</label>
                                        <input type="text" class="form-control form-control-sm" id="gender" required placeholder="M/F/O" list="genderList">
                                        <datalist id="genderList">
                                            <option value="M">Male</option>
                                            <option value="F">Female</option>
                                            <option value="O">Other</option>
                                        </datalist>
                                        <div class="invalid-feedback">Required</div>
                                    </div>
                                    <div class="col-lg-2 col-md-3 mb-2">
                                        <label for="marital_status" class="form-label">Marital</label>
                                        <input type="text" class="form-control form-control-sm" id="marital_status" placeholder="S/M/D" list="maritalList">
                                        <datalist id="maritalList">
                                            <option value="S">Single</option>
                                            <option value="M">Married</option>
                                            <option value="D">Divorced</option>
                                            <option value="W">Widowed</option>
                                            <option value="T">Domestic Partner</option>
                                            <option value="L">Separated</option>
                                        </datalist>
                                    </div>
                                    <div class="col-lg-1 col-md-2 mb-2">
                                        <label for="language_primary" class="form-label">Lang</label>
                                        <input type="text" class="form-control form-control-sm" id="language_primary" placeholder="th" list="languageList">
                                        <datalist id="languageList">
                                            <option value="th">Thai</option>
                                            <option value="en">English</option>
                                            <option value="zh">Chinese</option>
                                            <option value="fr">French</option>
                                            <option value="de">German</option>
                                            <option value="ja">Japanese</option>
                                            <option value="es">Spanish</option>
                                        </datalist>
                                    </div>
                                    <div class="col-lg-2 col-md-3 mb-2">
                                        <label for="phone" class="form-label">Phone</label>
                                        <input type="tel" class="form-control form-control-sm" id="phone" placeholder="0812345678">
                                    </div>
                                    <div class="col-lg-2 col-md-3 mb-2">
                                        <label for="mobile" class="form-label">Mobile</label>
                                        <input type="tel" class="form-control form-control-sm" id="mobile" placeholder="0898765432">
                                    </div>
                                    <div class="col-lg-1 col-md-2 mb-2">
                                        <label for="fax" class="form-label">Fax</label>
                                        <input type="tel" class="form-control form-control-sm" id="fax" placeholder="Fax">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-6 col-md-6 mb-2">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control form-control-sm" id="email" placeholder="patient@example.com">
                                        <div class="invalid-feedback">Invalid email</div>
                                    </div>
                                    <div class="col-lg-6 col-md-6 mb-2">
                                        <label for="address" class="form-label">Address</label>
                                        <input type="text" class="form-control form-control-sm" id="address" placeholder="Complete address">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-3 col-md-4 mb-2">
                                        <label for="address_line1" class="form-label">Address Line 1</label>
                                        <input type="text" class="form-control form-control-sm" id="address_line1" placeholder="Street">
                                    </div>
                                    <div class="col-lg-3 col-md-4 mb-2">
                                        <label for="address_line2" class="form-label">Address Line 2</label>
                                        <input type="text" class="form-control form-control-sm" id="address_line2" placeholder="Apt/Unit">
                                    </div>
                                    <div class="col-lg-2 col-md-4 mb-2">
                                        <label for="address_city" class="form-label">City</label>
                                        <input type="text" class="form-control form-control-sm" id="address_city" placeholder="Bangkok">
                                    </div>
                                    <div class="col-lg-2 col-md-4 mb-2">
                                        <label for="address_district" class="form-label">District</label>
                                        <input type="text" class="form-control form-control-sm" id="address_district" placeholder="District">
                                    </div>
                                    <div class="col-lg-2 col-md-4 mb-2">
                                        <label for="address_state" class="form-label">State</label>
                                        <input type="text" class="form-control form-control-sm" id="address_state" placeholder="Province">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-2 col-md-3 mb-2">
                                        <label for="address_postal_code" class="form-label">Postal Code</label>
                                        <input type="text" class="form-control form-control-sm" id="address_postal_code" placeholder="10100">
                                    </div>
                                    <div class="col-lg-2 col-md-3 mb-2">
                                        <label for="address_country" class="form-label">Country</label>
                                        <input type="text" class="form-control form-control-sm" id="address_country" value="TH" placeholder="TH" list="countryList">
                                        <datalist id="countryList">
                                            <option value="TH">Thailand</option>
                                            <option value="US">United States</option>
                                            <option value="GB">United Kingdom</option>
                                            <option value="CN">China</option>
                                            <option value="JP">Japan</option>
                                            <option value="DE">Germany</option>
                                            <option value="FR">France</option>
                                        </datalist>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 3: Emergency Contact + Clinical Information -->
                    <div class="row">
                        <div class="col-lg-6 mb-2">
                            <!-- ==================== EMERGENCY CONTACT ==================== -->
                            <div class="form-section h-100">
                                <h5><i class="bi bi-person-exclamation me-2"></i>Emergency Contact</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="emergency_contact" class="form-label">Contact Name</label>
                                        <input type="text" class="form-control form-control-sm" id="emergency_contact" placeholder="Full name">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="emergency_relationship" class="form-label">Relationship</label>
                                        <input type="text" class="form-control form-control-sm" id="emergency_relationship" placeholder="Spouse/Parent" list="relationshipList">
                                        <datalist id="relationshipList">
                                            <option value="spouse">Spouse</option>
                                            <option value="parent">Parent</option>
                                            <option value="child">Child</option>
                                            <option value="sibling">Sibling</option>
                                            <option value="friend">Friend</option>
                                            <option value="other">Other</option>
                                        </datalist>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="emergency_phone" class="form-label">Phone</label>
                                        <input type="tel" class="form-control form-control-sm" id="emergency_phone" placeholder="0812345678">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="emergency_email" class="form-label">Email</label>
                                        <input type="email" class="form-control form-control-sm" id="emergency_email" placeholder="contact@example.com">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 mb-2">
                                        <label for="emergency_address" class="form-label">Address</label>
                                        <input type="text" class="form-control form-control-sm" id="emergency_address" placeholder="Address">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 mb-2">
                            <!-- ==================== CLINICAL INFORMATION ==================== -->
                            <div class="form-section h-100">
                                <h5><i class="bi bi-heart-pulse me-2"></i>Clinical Information</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="diagnosis" class="form-label required">Diagnosis</label>
                                        <textarea class="form-control form-control-sm" id="diagnosis" rows="2" required placeholder="Chief complaint"></textarea>
                                        <div class="invalid-feedback">Required</div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="medical_history" class="form-label">Medical History</label>
                                        <textarea class="form-control form-control-sm" id="medical_history" rows="2" placeholder="Past conditions"></textarea>
                                    </div>
                                </div>
                                <div classs="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="allergies" class="form-label">Allergies</label>
                                        <textarea class="form-control form-control-sm" id="allergies" rows="2" placeholder="Known allergies"></textarea>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label for="medications" class="form-label">Medications</label>
                                        <textarea class="form-control form-control-sm" id="medications" rows="2" placeholder="Current meds"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ROW 4: Rehabilitation Plan (Full Width) -->
                    <div class="row">
                        <div class="col-12 mb-2">
                            <div class="form-section">
                                <h5><i class="bi bi-clipboard2-pulse me-2"></i>Rehabilitation Plan</h5>
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <label class="form-label">Rehab Goals</label>
                                        <div class="row">
                                            <div class="col-lg-2 col-md-3 col-6">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" value="Pain reduction" id="goal1">
                                                    <label class="form-check-label small" for="goal1">Pain reduction</label>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-md-3 col-6">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" value="Improve ROM" id="goal2">
                                                    <label class="form-check-label small" for="goal2">Improve ROM</label>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-md-3 col-6">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" value="Strengthen muscles" id="goal3">
                                                    <label class="form-check-label small" for="goal3">Strengthen</label>
                                                </div>
                                            </div>
                                            <div class="col-lg-2 col-md-3 col-6">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" value="Improve function" id="goal4">
                                                    <label class="form-check-label small" for="goal4">Improve function</label>
                                                </div>
                                            </div>
                                            <div class="col-lg-4 col-md-12">
                                                <input type="text" class="form-control form-control-sm" id="rehab_goal_other" placeholder="Other goals">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-2 col-md-4 mb-2">
                                        <label for="body_area" class="form-label">Body Area</label>
                                        <select class="form-select form-select-sm" id="body_area">
                                            <option value="">Select</option>
                                            <option value="Neck">Neck</option>
                                            <option value="Shoulder">Shoulder</option>
                                            <option value="Elbow">Elbow</option>
                                            <option value="Wrist/Hand">Wrist/Hand</option>
                                            <option value="Upper Back">Upper Back</option>
                                            <option value="Lower Back">Lower Back</option>
                                            <option value="Hip">Hip</option>
                                            <option value="Knee">Knee</option>
                                            <option value="Ankle/Foot">Ankle/Foot</option>
                                            <option value="Multiple Areas">Multiple</option>
                                        </select>
                                    </div>
                                    <div class="col-lg-2 col-md-4 mb-2">
                                        <label for="frequency" class="form-label">Frequency</label>
                                        <select class="form-select form-select-sm" id="frequency">
                                            <option value="">Select</option>
                                            <option value="Daily">Daily</option>
                                            <option value="3 times/week">3x/week</option>
                                            <option value="2 times/week">2x/week</option>
                                            <option value="Weekly">Weekly</option>
                                            <option value="As needed">As needed</option>
                                        </select>
                                    </div>
                                    <div class="col-lg-2 col-md-4 mb-2">
                                        <label for="expected_duration" class="form-label">Duration</label>
                                        <select class="form-select form-select-sm" id="expected_duration">
                                            <option value="">Select</option>
                                            <option value="1-2 weeks">1-2 weeks</option>
                                            <option value="2-4 weeks">2-4 weeks</option>
                                            <option value="1-2 months">1-2 months</option>
                                            <option value="2-3 months">2-3 months</option>
                                            <option value="3-6 months">3-6 months</option>
                                            <option value="Long-term">Long-term</option>
                                        </select>
                                    </div>
                                    <div class="col-lg-2 col-md-4 mb-2">
                                        <label for="precaution" class="form-label">Precautions</label>
                                        <textarea class="form-control form-control-sm" id="precaution" rows="2" placeholder="Precautions"></textarea>
                                    </div>
                                    <div class="col-lg-2 col-md-4 mb-2">
                                        <label for="contraindication" class="form-label">Contraindications</label>
                                        <textarea class="form-control form-control-sm" id="contraindication" rows="2" placeholder="Contraindications"></textarea>
                                    </div>
                                    <div class="col-lg-2 col-md-4 mb-2">
                                        <label for="doctor_note" class="form-label">Doctor's Notes</label>
                                        <textarea class="form-control form-control-sm" id="doctor_note" rows="2" placeholder="Notes"></textarea>
                                    </div>
                                </div>

                                <!-- === MOVED CLINIC ASSIGNMENT === -->
                                <% if (user.role === 'ADMIN' || user.role === 'PT' || user.role === 'PT_ADMIN') { %>
                                <div class="row mt-3 pt-3 border-top"> <!-- Added divider -->
                                    <div class="col-lg-6">
                                        <h5><i class="bi bi-building me-2"></i>Clinic Assignment</h5>
                                        <div class="row">
                                            <div class="col-md-12 mb-2">
                                                <label for="clinic_id" class="form-label required">Clinic</label>
                                                <select class="form-select form-select-sm" id="clinic_id" required>
                                                    <option value="">Select Clinic</option>
                                                </select>
                                                <div class="invalid-feedback">Please select a clinic</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% } %>
                                <!-- === END MOVED BLOCK === -->

                            </div>
                        </div>
                    </div>

                    <!-- ROW 5: Clinic Assignment (This block is now removed) -->
                    <% /* <div class="row">
                        <div class="col-lg-6 mb-2">
...
                        </div>
                    </div>
                    */ %>

                    <!-- ==================== ACTION BUTTONS ==================== -->
                    <div class="text-center mt-4 mb-5">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="bi bi-save me-2"></i>Register Patient
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg ms-3 px-5" onclick="clearForm()">
                            <i class="bi bi-x-circle me-2"></i>Clear Form
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // ============================================================================
        // HL7 FHIR Patient Registration - Enhanced JavaScript
        // ============================================================================

        // Utility function: Get cookie value
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Format date from DD/MM/YYYY to YYYY-MM-DD for backend
        function convertDateToISO(dateStr) {
            if (!dateStr) return '';

            // If already in YYYY-MM-DD format, return as-is
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }

            // Convert DD/MM/YYYY to YYYY-MM-DD
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }

            return dateStr;
        }

        // Validate DD/MM/YYYY date format
        function validateDateFormat(dateStr) {
            if (!dateStr) return false;

            // Accept DD/MM/YYYY or D/M/YYYY
            const regex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
            const match = dateStr.match(regex);

            if (!match) return false;

            const day = parseInt(match[1], 10);
            const month = parseInt(match[2], 10);
            const year = parseInt(match[3], 10);

            // Check valid ranges
            if (month < 1 || month > 12) return false;
            if (day < 1 || day > 31) return false;
            if (year < 1900 || year > new Date().getFullYear()) return false;

            // Check valid day for month
            const daysInMonth = new Date(year, month, 0).getDate();
            if (day > daysInMonth) return false;

            return true;
        }

        // Auto-format date as user types (adds slashes automatically if typing numbers only)
        document.getElementById('dob')?.addEventListener('input', (e) => {
            let value = e.target.value;

            // If user is typing with slashes, allow it (don't reformat)
            if (value.includes('/')) {
                // Just limit to DD/MM/YYYY format
                const parts = value.split('/');
                if (parts[0] && parts[0].length > 2) parts[0] = parts[0].substring(0, 2);
                if (parts[1] && parts[1].length > 2) parts[1] = parts[1].substring(0, 2);
                if (parts[2] && parts[2].length > 4) parts[2] = parts[2].substring(0, 4);
                e.target.value = parts.join('/');
                return;
            }

            // If typing numbers only, auto-add slashes
            value = value.replace(/\D/g, ''); // Remove non-digits

            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }

            e.target.value = value;
        });

        // Add date validation on blur
        document.getElementById('dob')?.addEventListener('blur', (e) => {
            const value = e.target.value.trim();
            if (value && !validateDateFormat(value)) {
                e.target.classList.add('is-invalid');
                e.target.setCustomValidity('Invalid date format. Use DD/MM/YYYY');
            } else {
                e.target.classList.remove('is-invalid');
                e.target.setCustomValidity('');
                if (value) e.target.classList.add('is-valid');
            }
        });

        // Load clinics
        async function loadClinics() {
            try {
                const token = getCookie('authToken');
                const response = await fetch('/api/clinics', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const clinics = await response.json();
                    const select = document.getElementById('clinic_id');
                    if (select) {
                        clinics.forEach(clinic => {
                            const option = document.createElement('option');
                            option.value = clinic.id;
                            option.textContent = clinic.name;
                            select.appendChild(option);
                        });

                        // Pre-select user's clinic if CLINIC role
                        const user = JSON.parse(localStorage.getItem('user') || '{}');
                        if (user.role === 'CLINIC' && user.clinic_id) {
                            select.value = user.clinic_id;
                            select.disabled = true;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading clinics:', error);
            }
        }

        // Validate Thai National ID (13 digits with checksum)
        function validateThaiNationalID(id) {
            if (!/^\d{13}$/.test(id)) return false;

            let sum = 0;
            for (let i = 0; i < 12; i++) {
                sum += parseInt(id[i]) * (13 - i);
            }
            const checksum = (11 - (sum % 11)) % 10;
            return checksum === parseInt(id[12]);
        }

        // Validate email (RFC 5322 simplified)
        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // Auto-fill address text from structured fields
        function updateAddressText() {
            const line1 = document.getElementById('address_line1')?.value || '';
            const line2 = document.getElementById('address_line2')?.value || '';
            const city = document.getElementById('address_city')?.value || '';
            const district = document.getElementById('address_district')?.value || '';
            const state = document.getElementById('address_state')?.value || '';
            const postal = document.getElementById('address_postal_code')?.value || '';
            const country = document.getElementById('address_country')?.selectedOptions[0]?.text || '';

            const parts = [line1, line2, city, district, state, postal, country].filter(p => p.trim() !== '');
            const fullAddress = parts.join(', ');

            if (fullAddress) {
                document.getElementById('address').value = fullAddress;
            }
        }

        // Setup auto-fill listeners
        const addressFields = ['address_line1', 'address_line2', 'address_city', 'address_district', 'address_state', 'address_postal_code', 'address_country'];
        addressFields.forEach(fieldId => {
            document.getElementById(fieldId)?.addEventListener('input', updateAddressText);
        });

        // Validate National ID on blur
        document.getElementById('pid')?.addEventListener('blur', (e) => {
            const value = e.target.value;
            if (value && value.length === 13) {
                if (!validateThaiNationalID(value)) {
                    e.target.classList.add('is-invalid');
                } else {
                    e.target.classList.remove('is-invalid');
                    e.target.classList.add('is-valid');
                }
            }
        });

        // Validate email on blur
        document.getElementById('email')?.addEventListener('blur', (e) => {
            const value = e.target.value;
            if (value && !validateEmail(value)) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
                if (value) e.target.classList.add('is-valid');
            }
        });

        // Form submission with HL7 FHIR data
        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate form
            const form = e.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                showAlert('Please fill in all required fields correctly', 'danger');
                return;
            }

            // Collect rehabilitation goals
            const goals = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                goals.push(cb.value);
            });
            const otherGoals = document.getElementById('rehab_goal_other').value;
            if (otherGoals) {
                goals.push(...otherGoals.split(',').map(g => g.trim()));
            }

            // Validate and convert date
            const dobValue = document.getElementById('dob').value.trim();
            if (dobValue && !validateDateFormat(dobValue)) {
                showAlert('Please enter a valid date in DD/MM/YYYY format', 'danger');
                document.getElementById('dob').focus();
                return;
            }

            // Build HL7 FHIR-compliant payload (backward compatible with existing API)
            const formData = {
                // Identifiers
                hn: document.getElementById('hn').value,
                pt_number: document.getElementById('pt_number').value || undefined,
                pid: document.getElementById('pid').value,
                passport_no: document.getElementById('passport_no').value,
                ssn: document.getElementById('ssn').value,

                // Name
                title: document.getElementById('title').value,
                first_name: document.getElementById('first_name').value,
                middle_name: document.getElementById('middle_name').value,
                last_name: document.getElementById('last_name').value,

                // Demographics
                gender: document.getElementById('gender').value,
                dob: convertDateToISO(dobValue), // Convert DD/MM/YYYY to YYYY-MM-DD
                marital_status: document.getElementById('marital_status').value,
                language_primary: document.getElementById('language_primary').value,

                // Contact
                phone: document.getElementById('phone').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value,
                fax: document.getElementById('fax').value,

                // Address (structured)
                address_line1: document.getElementById('address_line1').value,
                address_line2: document.getElementById('address_line2').value,
                address_city: document.getElementById('address_city').value,
                address_district: document.getElementById('address_district').value,
                address_state: document.getElementById('address_state').value,
                address_postal_code: document.getElementById('address_postal_code').value,
                address_country: document.getElementById('address_country').value,
                address: document.getElementById('address').value,

                // Emergency Contact
                emergency_contact: document.getElementById('emergency_contact').value,
                emergency_relationship: document.getElementById('emergency_relationship').value,
                emergency_phone: document.getElementById('emergency_phone').value,
                emergency_email: document.getElementById('emergency_email').value,
                emergency_address: document.getElementById('emergency_address').value,

                // Clinical
                diagnosis: document.getElementById('diagnosis').value,
                medical_history: document.getElementById('medical_history').value,
                allergies: document.getElementById('allergies').value,
                medications: document.getElementById('medications').value,

                // Rehabilitation
                rehab_goal: goals.join(', '),
                rehab_goal_other: document.getElementById('rehab_goal_other').route,
                body_area: document.getElementById('body_area').value,
                frequency: document.getElementById('frequency').value,
                expected_duration: document.getElementById('expected_duration').value,
                precaution: document.getElementById('precaution').value,
                contraindication: document.getElementById('contraindication').value,
                doctor_note: document.getElementById('doctor_note').value
            };

            // Add clinic_id if available
            const clinicSelect = document.getElementById('clinic_id');
            if (clinicSelect) {
                formData.clinic_id = clinicSelect.value;
            }

            try {
                const token = getCookie('authToken');
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Registering...';

                const response = await fetch('/api/patients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(`Patient registered successfully!<br>PT Number: ${result.pt_number}`, 'success');

                    // Ask if want to create PN case
                    setTimeout(() => {
                        if (confirm('Do you want to create a PN case for this patient?')) {
                            window.location.href = `/patient/${result.patient_id}#create-pn`;
                        } else {
                            window.location.href = '/patients';
                        }
                    }, 1000);
                } else {
                    const error = await response.json();
                    showAlert('Error: ' + (error.error || 'Registration failed'), 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Network error:', error);
                showAlert('Network error. Please try again.', 'danger');
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-save me-2"></i>Register Patient';
            }
        });

        function clearForm() {
            if (confirm('Are you sure you want to clear all form data? This cannot be undone.')) {
                document.getElementById('patientForm').reset();
                document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
                    el.classList.remove('is-valid', 'is-invalid');
                });
                showAlert('Form cleared', 'info');
            }
        }

        function showAlert(message, type = 'info') {
            const existingAlerts = document.querySelectorAll('.alert-dismissible');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const main = document.querySelector('main');
            main.insertBefore(alertDiv, main.firstChild.nextSibling);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadClinics();
            console.log('HL7 FHIR Patient Registration - Ready');
        });
    </script>

    <!-- HN Validation Alert Templates -->
    <template id="templateIdAvailable">
        <div class="alert alert-success" role="alert">
            <div class="d-flex align-items-start">
                <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-1" style="font-size: 0.9rem;">ID Verified - Ready to Create Patient</h6>
                    <p class="mb-2" style="font-size: 0.8rem;">This ID is not registered in the system.</p>
                    <div class="bg-white p-2 rounded border">
                        <strong style="font-size: 0.8rem;">New PTHN will be:</strong>
                        <span class="badge bg-primary" id="previewPTHN" style="font-size: 0.85rem;">PT250001</span>
                    </div>
                    <small class="text-muted d-block mt-2">
                        You can now fill in patient details and submit the form.
                    </small>
                </div>
            </div>
        </div>
    </template>

    <template id="templateIdExists">
        <div class="alert alert-warning" role="alert">
            <div class="d-flex align-items-start">
                <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-1" style="font-size: 0.9rem;">Duplicate ID Detected</h6>
                    <p class="mb-2" style="font-size: 0.8rem;">This ID is already registered in the system:</p>

                    <div class="card bg-white mb-2">
                        <div class="card-body p-2">
                            <div class="row g-2 small" style="font-size: 0.75rem;">
                                <div class="col-md-6"><strong>HN:</strong> <span id="existingHN">-</span></div>
                                <div class="col-md-6"><strong>PT#:</strong> <span id="existingPT">-</span></div>
                                <div class="col-md-6"><strong>Name:</strong> <span id="existingName">-</span></div>
                                <div class="col-md-6"><strong>DOB:</strong> <span id="existingDOB">-</span></div>
                                <div class="col-md-6"><strong>Clinic:</strong> <span id="existingClinic">-</span></div>
                                <div class="col-md-6"><strong>Registered:</strong> <span id="existingDate">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnViewPatient">
                            <i class="bi bi-eye"></i> View Patient Details
                        </button>
                        <button type="button" class="btn btn-sm btn-warning" id="btnCreatePN">
                            <i class="bi bi-plus-circle"></i> Create New PN Case Instead
                        </button>
                    </div>

                    <small class="text-muted d-block mt-2">
                        <strong>Note:</strong> If you need to create a new treatment case (PN) for this existing patient, click "Create New PN Case Instead".
                    </small>
                </div>
            </div>
        </div>
    </template>

    <template id="templateVerificationError">
        <div class="alert alert-danger" role="alert">
            <div class="d-flex align-items-start">
                <i class="bi bi-x-circle-fill me-2 fs-5"></i>
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-1" style="font-size: 0.9rem;">Verification Failed</h6>
                    <p class="mb-0" style="font-size: 0.8rem;" id="errorMessage">Unable to verify ID. Please try again.</p>
                </div>
            </div>
        </div>
    </template>

    <!-- Load HN Validation JavaScript -->
    <script src="/js/hn-validation.js"></script>

</body>
</html>
