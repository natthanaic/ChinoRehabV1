<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bills Management - RehabPlus System</title>
    <link rel="icon" href="/public/images/Fav.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Design System -->
    <link href="/public/css/variables.css" rel="stylesheet">
    <link href="/public/css/base.css" rel="stylesheet">
    <link href="/public/css/accessibility.css" rel="stylesheet">
    <style>
        body {
            background: #f5f7fb;
            min-height: 100vh;
        }

        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.08);
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.85);
            padding: 0.75rem 1rem;
            margin: 0.25rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        main {
            min-height: 100vh;
            padding-bottom: 4rem;
        }

        .page-header {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(82, 95, 225, 0.12);
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-weight: 700;
            color: #2d2f44;
        }

        .page-header p {
            color: #6c6f93;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            font-weight: 600;
            padding: 0.6rem 1.6rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.35);
        }

        .filters-card,
        .bills-card {
            border: none;
            border-radius: 1.25rem;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        }

        .filters-card .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(102, 126, 234, 0.15);
            font-weight: 600;
            color: #2d2f44;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .modal-content {
            border: none;
            border-radius: 1.25rem;
        }

        .table thead th {
            background: rgba(102, 126, 234, 0.08);
            color: #2d2f44;
            font-weight: 600;
            border: none;
        }

        .badge {
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
        }

        .badge-success {
            background: #198754;
        }

        .badge-danger {
            background: #dc3545;
        }

        .badge-warning {
            background: #ffc107;
            color: #000;
        }

        .badge-secondary {
            background: #6c757d;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Mobile navbar toggle -->
    <nav class="navbar navbar-dark bg-dark d-md-none">
        <div class="container-fluid">
            <span class="navbar-brand">RehabPlus System</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <%- include('partials/sidebar', { user, activePage: 'bills' }) %>

            <main id="main-content" class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4" role="main" aria-label="Bills management">
                <div class="page-header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
                    <div>
                        <h1 class="h3 mb-2"><i class="bi bi-receipt me-2 text-primary" aria-hidden="true"></i>Bills Management</h1>
                        <p class="mb-0">Manage billing and invoices for patient services.</p>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary" id="btn-create-bill">
                            <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>Create Bill
                        </button>
                        <button type="button" class="btn btn-success" id="btn-export-template">
                            <i class="bi bi-download me-2" aria-hidden="true"></i>Export Template
                        </button>
                        <button type="button" class="btn btn-info" id="btn-import-bills">
                            <i class="bi bi-upload me-2" aria-hidden="true"></i>Import Bills
                        </button>
                    </div>
                </div>

                <div id="alerts-container"></div>

                <!-- Filters -->
                <div class="card filters-card mb-4">
                    <div class="card-header">
                        <i class="bi bi-funnel me-2 text-primary" aria-hidden="true"></i>Filter bills
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Bill Code</label>
                                <input type="text" id="filter-bill-code" class="form-control" placeholder="Search by bill code...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Clinic</label>
                                <select id="filter-clinic" class="form-select">
                                    <option value="">All Clinics</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select id="filter-status" class="form-select">
                                    <option value="">All Status</option>
                                    <option value="PAID">Paid</option>
                                    <option value="UNPAID">Unpaid</option>
                                    <option value="PARTIAL">Partial</option>
                                    <option value="CANCELLED">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">From Date</label>
                                <input type="date" id="filter-date-from" class="form-control">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">To Date</label>
                                <input type="date" id="filter-date-to" class="form-control">
                            </div>
                            <div class="col-md-1 align-self-end">
                                <button class="btn btn-primary w-100" id="btn-search-bills" title="Search">
                                    <i class="bi bi-search" aria-hidden="true"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bills Table -->
                <div class="card bills-card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Bill Code</th>
                                        <th>Patient</th>
                                        <th>Clinic</th>
                                        <th>Date</th>
                                        <th class="text-right">Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bills-table-body">
                                    <tr><td colspan="7" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Bill Modal -->
    <div class="modal fade" id="createBillModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2" aria-hidden="true"></i>Create New Bill</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Patient Selection -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Patient</label>
                            <input type="hidden" id="bill-patient-id">
                            <input type="text" id="bill-patient-name" class="form-control" readonly placeholder="Selected patient">
                            <input type="text" id="bill-patient-search" class="form-control mt-2" placeholder="Search patient...">
                            <div id="patient-search-results" class="list-group mt-2"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Walk-in Patient (Optional)</label>
                            <input type="text" id="bill-walk-in-name" class="form-control mb-2" placeholder="Walk-in name">
                            <input type="text" id="bill-walk-in-phone" class="form-control" placeholder="Phone">
                        </div>
                    </div>

                    <div id="patient-courses-info"></div>

                    <!-- Clinic Selection (Required) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Clinic <span class="text-danger">*</span></label>
                            <select id="bill-clinic" class="form-select" required>
                                <option value="">Select Clinic</option>
                            </select>
                            <small class="text-muted">Select clinic to load available services</small>
                        </div>
                    </div>

                    <!-- Bill Details -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Bill Date</label>
                            <input type="date" id="bill-date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Payment Method</label>
                            <select id="bill-payment-method" class="form-select">
                                <option value="">Select method</option>
                                <option value="CASH">Cash</option>
                                <option value="CREDIT_CARD">Credit Card</option>
                                <option value="TRANSFER">Bank Transfer</option>
                            </select>
                        </div>
                    </div>

                    <!-- Add Items -->
                    <h6>Bill Items</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select id="bill-item-service" class="form-select">
                                <option value="">Select Service</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="number" id="bill-item-quantity" class="form-control" value="1" min="1">
                        </div>
                        <div class="col-md-2">
                            <input type="number" id="bill-item-discount" class="form-control" value="0" min="0" placeholder="Discount">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-success w-100" id="btn-add-bill-item">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                    </div>

                    <div id="bill-items-container" class="mb-3">
                        <p class="text-muted">No items added</p>
                    </div>

                    <!-- Totals -->
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Notes</label>
                            <textarea id="bill-notes" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-6"><strong>Subtotal:</strong></div>
                                <div class="col-6 text-end" id="bill-subtotal">฿0.00</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <label>Discount:</label>
                                    <input type="number" id="bill-discount" class="form-control" value="0" min="0">
                                </div>
                                <div class="col-6">
                                    <label>Tax:</label>
                                    <input type="number" id="bill-tax" class="form-control" value="0" min="0">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6"><h5>Total:</h5></div>
                                <div class="col-6 text-end"><h5 id="bill-total">฿0.00</h5></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btn-save-bill">Save Bill</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Bill Modal -->
    <div class="modal fade" id="viewBillModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-receipt me-2" aria-hidden="true"></i>Bill Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="bill-details-content">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Simplified PN Bill Creation Modal -->
    <div class="modal fade" id="createPNBillModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-receipt-cutoff me-2" aria-hidden="true"></i>Create Bill for PN Case</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- PN Case Information (Read-only) -->
                    <div class="card mb-4" style="border-left: 4px solid #28a745; background: #f8fff9;">
                        <div class="card-body">
                            <h6 class="text-success mb-3"><i class="bi bi-link-45deg me-2" aria-hidden="true"></i>PN Case Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>PN Code:</strong> <span id="pn-bill-pn-code">-</span></p>
                                    <p class="mb-2"><strong>Patient:</strong> <span id="pn-bill-patient-name">-</span></p>
                                    <p class="mb-2"><strong>HN:</strong> <span id="pn-bill-patient-hn">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Diagnosis:</strong> <span id="pn-bill-diagnosis">-</span></p>
                                    <p class="mb-2"><strong>Purpose:</strong> <span id="pn-bill-purpose">-</span></p>
                                    <p class="mb-2"><strong>Clinic:</strong> <span id="pn-bill-clinic-name">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields for form data -->
                    <input type="hidden" id="pn-bill-pn-id">
                    <input type="hidden" id="pn-bill-patient-id">
                    <input type="hidden" id="pn-bill-clinic-id">

                    <!-- Service Selection (Only thing user needs to fill) -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-cart-plus me-2" aria-hidden="true"></i>Add Services</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <label class="form-label">Service</label>
                                    <select id="pn-bill-service" class="form-select">
                                        <option value="">Select Service</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" id="pn-bill-quantity" class="form-control" value="1" min="1">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Discount (฿)</label>
                                    <input type="number" id="pn-bill-item-discount" class="form-control" value="0" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-success w-100" id="btn-add-pn-bill-item">
                                        <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>Add Service
                                    </button>
                                </div>
                            </div>

                            <!-- Items Table -->
                            <div id="pn-bill-items-container">
                                <p class="text-muted text-center py-3">No services added yet</p>
                            </div>

                            <!-- Totals -->
                            <div class="row mt-4">
                                <div class="col-md-8"></div>
                                <div class="col-md-4">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Subtotal:</strong></td>
                                            <td class="text-end"><span id="pn-bill-subtotal">฿0.00</span></td>
                                        </tr>
                                        <tr class="table-success">
                                            <td><strong>TOTAL:</strong></td>
                                            <td class="text-end"><strong><span id="pn-bill-total">฿0.00</span></strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <!-- Optional: Payment Method & Notes -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label">Payment Method (Optional)</label>
                                    <select id="pn-bill-payment-method" class="form-select">
                                        <option value="">Select method</option>
                                        <option value="CASH">Cash</option>
                                        <option value="CREDIT_CARD">Credit Card</option>
                                        <option value="TRANSFER">Bank Transfer</option>
                                        <option value="QR_CODE">QR Code</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Notes (Optional)</label>
                                    <input type="text" id="pn-bill-notes" class="form-control" placeholder="Additional notes...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="btn-save-pn-bill">
                        <i class="bi bi-check-circle me-1" aria-hidden="true"></i>Create Bill
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Bills Modal -->
    <div class="modal fade" id="importBillsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8 0%, #00c9db 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-upload me-2" aria-hidden="true"></i>Import Bills from CSV</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
                        <strong>Instructions:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Download the CSV template by clicking "Export Template"</li>
                            <li>Fill in the template with bill data</li>
                            <li>Upload the completed CSV file below</li>
                        </ol>
                    </div>

                    <div class="mb-3">
                        <label for="import-file" class="form-label">Select CSV File</label>
                        <input class="form-control" type="file" id="import-file" accept=".csv">
                        <small class="text-muted">Accepted format: CSV (.csv)</small>
                    </div>

                    <div id="import-preview" class="mt-3" style="display: none;">
                        <h6>Preview:</h6>
                        <div id="import-preview-content"></div>
                    </div>

                    <div id="import-results" class="mt-3" style="display: none;">
                        <!-- Results will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btn-upload-csv" disabled>
                        <i class="bi bi-upload me-2" aria-hidden="true"></i>Upload & Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="user-clinic-id" value="<%= user.clinic_id %>">
    <input type="hidden" id="user-role" value="<%= user.role %>">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        window.userInfo = {
            id: <%= user.id %>,
            role: <%- JSON.stringify(user.role) %>,
            email: <%- JSON.stringify(user.email || '') %>
        };
    </script>
    <script src="/public/js/bills.js?v=<%= Date.now() %>"></script>
</body>
</html>